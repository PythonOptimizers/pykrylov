

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Benchmarking Solvers &mdash; PyKrylov 0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/agogo.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://d3eoax9i5htok0.cloudfront.net/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="PyKrylov 0.1 documentation" href="index.html" />
    <link rel="prev" title="The Symmetric Indefinite Method with Orthogonal Factorization" href="symmlq.html" /> 
  </head>
  <body>
    <div class="header-wrapper">
      <div class="header">
        <div class="headertitle"><a
          href="contents.html">PyKrylov 0.1 documentation</a></div>
        <div class="rel">
          <a href="symmlq.html" title="The Symmetric Indefinite Method with Orthogonal Factorization"
             accesskey="P">previous</a> |
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a>
        </div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="benchmarking-solvers">
<span id="bmark-page"></span><h1>Benchmarking Solvers<a class="headerlink" href="#benchmarking-solvers" title="Permalink to this headline">¶</a></h1>
<p>You may have noticed that in the examples of sections <a class="reference internal" href="cg.html#cg-page"><em>The Conjugate Gradient Method</em></a>,
<a class="reference internal" href="cgs.html#cgs-page"><em>The Conjugate Gradient Squared Method</em></a>, <a class="reference internal" href="bicgstab.html#bicgstab-page"><em>The Bi-Conjugate Gradient Stabilized Method</em></a> and <a class="reference internal" href="tfqmr.html#tfqmr-page"><em>The Transpose-Free Quasi-Minimal Residual Method</em></a>, the only line that
differs in the example scripts has the form</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pykrylov.tfqmr</span> <span class="kn">import</span> <span class="n">TFQMR</span> <span class="k">as</span> <span class="n">KSolver</span>
</pre></div>
</div>
<p>The rest of the code fragment is exactly the same across all examples. This
similarity could be used, for instance, to benchmark solvers on a set of test
problems.</p>
<p>Consider the script:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pykrylov.cgs</span> <span class="kn">import</span> <span class="n">CGS</span>
<span class="kn">from</span> <span class="nn">pykrylov.tfqmr</span> <span class="kn">import</span> <span class="n">TFQMR</span>
<span class="kn">from</span> <span class="nn">pykrylov.bicgstab</span> <span class="kn">import</span> <span class="n">BiCGSTAB</span>
<span class="kn">from</span> <span class="nn">pysparse</span> <span class="kn">import</span> <span class="n">spmatrix</span>
<span class="kn">from</span> <span class="nn">pysparse.pysparseMatrix</span> <span class="kn">import</span> <span class="n">PysparseMatrix</span> <span class="k">as</span> <span class="n">sp</span>

<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>

<span class="n">hdr</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%10s</span><span class="s">  </span><span class="si">%6s</span><span class="s">  </span><span class="si">%8s</span><span class="s">  </span><span class="si">%8s</span><span class="s">  </span><span class="si">%8s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="s">&#39;Matvec&#39;</span><span class="p">,</span> <span class="s">&#39;Resid0&#39;</span><span class="p">,</span> <span class="s">&#39;Resid&#39;</span><span class="p">,</span> <span class="s">&#39;Error&#39;</span><span class="p">)</span>
<span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%10s</span><span class="s">  </span><span class="si">%6d</span><span class="s">  </span><span class="si">%8.2e</span><span class="s">  </span><span class="si">%8.2e</span><span class="s">  </span><span class="si">%8.2e</span><span class="s">&#39;</span>
<span class="k">print</span> <span class="n">hdr</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">sp</span><span class="p">(</span><span class="n">matrix</span><span class="o">=</span><span class="n">spmatrix</span><span class="o">.</span><span class="n">ll_mat_from_mtx</span><span class="p">(</span><span class="s">&#39;jpwh_991.mtx&#39;</span><span class="p">))</span>

<span class="n">n</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">rhs</span> <span class="o">=</span> <span class="n">A</span><span class="o">*</span><span class="n">e</span>

<span class="c"># Loop through solvers using tighter stopping tolerance</span>
<span class="k">for</span> <span class="n">KSolver</span> <span class="ow">in</span> <span class="p">[</span><span class="n">CGS</span><span class="p">,</span> <span class="n">TFQMR</span><span class="p">,</span> <span class="n">BiCGSTAB</span><span class="p">]:</span>
    <span class="n">ks</span> <span class="o">=</span> <span class="n">KSolver</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">A</span><span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">reltol</span><span class="o">=</span><span class="mf">1.0e-8</span><span class="p">)</span>
    <span class="n">ks</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">guess</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span> <span class="n">matvec_max</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>

    <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ks</span><span class="o">.</span><span class="n">bestSolution</span><span class="o">-</span><span class="n">e</span><span class="p">)</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">fmt</span> <span class="o">%</span> <span class="p">(</span><span class="n">ks</span><span class="o">.</span><span class="n">acronym</span><span class="p">,</span> <span class="n">ks</span><span class="o">.</span><span class="n">nMatvec</span><span class="p">,</span> <span class="n">ks</span><span class="o">.</span><span class="n">residNorm0</span><span class="p">,</span> <span class="n">ks</span><span class="o">.</span><span class="n">residNorm</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</pre></div>
</div>
<p>Executing the script above produces the formatted output:</p>
<div class="highlight-python"><pre>     Name  Matvec    Resid0     Resid     Error
      CGS      82  8.64e+03  3.25e-05  2.35e-06
    TFQMR      84  8.64e+03  8.97e-06  1.22e-06
Bi-CGSTAB      84  8.64e+03  5.57e-05  4.04e-06</pre>
</div>
<div class="section" id="example-with-preconditioning">
<h2>Example with Preconditioning<a class="headerlink" href="#example-with-preconditioning" title="Permalink to this headline">¶</a></h2>
<p>A preconditioner can be supplied to any Krylov solver via the <cite>precon</cite> keyword
argument upon instantiation.</p>
<p>For example, we could supply a simple (and naive) diagonal preconditioner by
modifying the benchmarking script as:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pykrylov.cgs</span> <span class="kn">import</span> <span class="n">CGS</span>
<span class="kn">from</span> <span class="nn">pykrylov.tfqmr</span> <span class="kn">import</span> <span class="n">TFQMR</span>
<span class="kn">from</span> <span class="nn">pykrylov.bicgstab</span> <span class="kn">import</span> <span class="n">BiCGSTAB</span>
<span class="kn">from</span> <span class="nn">pysparse</span> <span class="kn">import</span> <span class="n">spmatrix</span>
<span class="kn">from</span> <span class="nn">pysparse.pysparseMatrix</span> <span class="kn">import</span> <span class="n">PysparseMatrix</span> <span class="k">as</span> <span class="n">sp</span>

<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>

<span class="n">hdr</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%10s</span><span class="s">  </span><span class="si">%6s</span><span class="s">  </span><span class="si">%8s</span><span class="s">  </span><span class="si">%8s</span><span class="s">  </span><span class="si">%8s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="s">&#39;Matvec&#39;</span><span class="p">,</span> <span class="s">&#39;Resid0&#39;</span><span class="p">,</span> <span class="s">&#39;Resid&#39;</span><span class="p">,</span> <span class="s">&#39;Error&#39;</span><span class="p">)</span>
<span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%10s</span><span class="s">  </span><span class="si">%6d</span><span class="s">  </span><span class="si">%8.2e</span><span class="s">  </span><span class="si">%8.2e</span><span class="s">  </span><span class="si">%8.2e</span><span class="s">&#39;</span>
<span class="k">print</span> <span class="n">hdr</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">sp</span><span class="p">(</span><span class="n">matrix</span><span class="o">=</span><span class="n">spmatrix</span><span class="o">.</span><span class="n">ll_mat_from_mtx</span><span class="p">(</span><span class="s">&#39;jpwh_991.mtx&#39;</span><span class="p">))</span>

<span class="c"># Extract diagonal of A and make it sufficiently positive</span>
<span class="n">diagA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">takeDiagonal</span><span class="p">()),</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="n">n</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">rhs</span> <span class="o">=</span> <span class="n">A</span><span class="o">*</span><span class="n">e</span>

<span class="c"># Loop through solvers using default stopping tolerance</span>
<span class="k">for</span> <span class="n">KSolver</span> <span class="ow">in</span> <span class="p">[</span><span class="n">CGS</span><span class="p">,</span> <span class="n">TFQMR</span><span class="p">,</span> <span class="n">BiCGSTAB</span><span class="p">]:</span>
    <span class="n">ks</span> <span class="o">=</span> <span class="n">KSolver</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">A</span><span class="o">*</span><span class="n">v</span><span class="p">,</span>
                 <span class="n">precon</span><span class="o">=</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">u</span><span class="o">/</span><span class="n">diagA</span><span class="p">,</span>
                 <span class="n">reltol</span><span class="o">=</span><span class="mf">1.0e-8</span><span class="p">)</span>
    <span class="n">ks</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">guess</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span> <span class="n">matvec_max</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>

    <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ks</span><span class="o">.</span><span class="n">bestSolution</span><span class="o">-</span><span class="n">e</span><span class="p">)</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">fmt</span> <span class="o">%</span> <span class="p">(</span><span class="n">ks</span><span class="o">.</span><span class="n">acronym</span><span class="p">,</span> <span class="n">ks</span><span class="o">.</span><span class="n">nMatvec</span><span class="p">,</span> <span class="n">ks</span><span class="o">.</span><span class="n">residNorm</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</pre></div>
</div>
<p>This time, the output is a bit better than before:</p>
<div class="highlight-python"><pre>     Name  Matvec    Resid0     Resid     Error
      CGS      70  8.64e+03  7.84e-06  2.33e-07
    TFQMR      70  8.64e+03  7.61e-06  2.47e-07
Bi-CGSTAB      64  8.64e+03  8.54e-05  4.93e-06</pre>
</div>
<p>Much in the same way, a modification of the script above could be used to loop
through preconditioners with a given solver.</p>
<p>Note that preconditioners need not be functions but can be more general
objects. The only requirement is that they should be callable. For example, the
same effect as above can be achieved by instead defining the preconditioner as:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">DiagonalPrec</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;Diag&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">takeDiagonal</span><span class="p">()),</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="s">&quot;Return the result of applying preconditioner to y&quot;</span>
        <span class="k">return</span> <span class="n">y</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">diag</span>
</pre></div>
</div>
<p>If <cite>dp</cite> is an instance of the <cite>DiagonalPrec</cite> class and <cite>y</cite> is a Numpy array of
appropriate size, one solves preconditioning systems by simply calling
<cite>x=dp(y)</cite>. A call to a Krylov solver might thus look like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Create diagonal preconditioner</span>
<span class="n">dp</span> <span class="o">=</span> <span class="n">DiagonalPrec</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

<span class="n">ks</span> <span class="o">=</span> <span class="n">KSolver</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">A</span><span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">precon</span><span class="o">=</span><span class="n">dp</span><span class="p">,</span> <span class="n">reltol</span><span class="o">=</span><span class="mf">1.0e-8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="linop.html">Linear Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="generic.html">Generic Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="cg.html">Conjugate Gradient</a></li>
<li class="toctree-l1"><a class="reference internal" href="cgs.html">Conjugate Gradient Squared</a></li>
<li class="toctree-l1"><a class="reference internal" href="bicgstab.html">Bi-Conjugate Gradient Stabilized</a></li>
<li class="toctree-l1"><a class="reference internal" href="tfqmr.html">Transpose-Free Quasi-Minimum Residual</a></li>
<li class="toctree-l1"><a class="reference internal" href="symmlq.html">Symmetric Indefinite Method with Orthogonal Factorization</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Benchmarking Solvers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#example-with-preconditioning">Example with Preconditioning</a></li>
</ul>
</li>
</ul>

          <h3 style="margin-top: 1.5em;">Search</h3>
          <form class="search" action="search.html" method="get">
            <input type="text" name="q" />
            <input type="submit" value="Go" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
          </form>
          <p class="searchtip" style="font-size: 90%">
            Enter search terms or a module, class or function name.
          </p>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
          <a href="symmlq.html" title="The Symmetric Indefinite Method with Orthogonal Factorization"
             >previous</a> |
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |
          <a href="genindex.html" title="General Index"
             >index</a>
            <br/>
            <a href="_sources/bmark.txt"
               rel="nofollow">Show Source</a>
        </div>

        <div class="right">
          
    <div class="footer">
        &copy; Copyright 2008, D. Orban.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>