<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>9. Benchmarking Solvers &mdash; PyKrylov 0.2 documentation</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootswatch-3.1.0/spacelab/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.1.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="PyKrylov 0.2 documentation" href="index.html" />
    <link rel="prev" title="8. The Symmetric Indefinite Method with Orthogonal Factorization" href="symmlq.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>
  
  <a href="https://github.com/dpo/pykrylov"
     class="visible-desktop"><img
    style="position: absolute; top: 40px; right: 0; border: 0;"
    src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"
    alt="Fork me on GitHub"></a>


  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="contents.html">
          PyKrylov</a>
        <span class="navbar-text navbar-version pull-left"><b>0.2</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="contents.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="linop.html">2. Linear Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="generic.html">3. Generic Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="cg.html">4. Conjugate Gradient</a></li>
<li class="toctree-l1"><a class="reference internal" href="cgs.html">5. Conjugate Gradient Squared</a></li>
<li class="toctree-l1"><a class="reference internal" href="bicgstab.html">6. Bi-Conjugate Gradient Stabilized</a></li>
<li class="toctree-l1"><a class="reference internal" href="tfqmr.html">7. Transpose-Free Quasi-Minimum Residual</a></li>
<li class="toctree-l1"><a class="reference internal" href="symmlq.html">8. Symmetric Indefinite Method with Orthogonal Factorization</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">9. Benchmarking Solvers</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">9. Benchmarking Solvers</a><ul>
<li><a class="reference internal" href="#example-with-preconditioning">9.1. Example with Preconditioning</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="symmlq.html" title="Previous Chapter: 8. The Symmetric Indefinite Method with Orthogonal Factorization"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm">&laquo; 8. The Symmetric...</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <div class="section" id="benchmarking-solvers">
<span id="bmark-page"></span><h1>9. Benchmarking Solvers<a class="headerlink" href="#benchmarking-solvers" title="Permalink to this headline">¶</a></h1>
<p>You may have noticed that in the examples of sections <a class="reference internal" href="cg.html#cg-page"><em>The Conjugate Gradient Method</em></a>,
<a class="reference internal" href="cgs.html#cgs-page"><em>The Conjugate Gradient Squared Method</em></a>, <a class="reference internal" href="bicgstab.html#bicgstab-page"><em>The Bi-Conjugate Gradient Stabilized Method</em></a> and <a class="reference internal" href="tfqmr.html#tfqmr-page"><em>The Transpose-Free Quasi-Minimal Residual Method</em></a>, the only line that
differs in the example scripts has the form</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">pykrylov.tfqmr</span> <span class="kn">import</span> <span class="n">TFQMR</span> <span class="k">as</span> <span class="n">KSolver</span>
</pre></div>
</div>
<p>The rest of the code fragment is exactly the same across all examples. This
similarity could be used, for instance, to benchmark solvers on a set of test
problems.</p>
<p>Consider the script:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pykrylov.cgs</span> <span class="kn">import</span> <span class="n">CGS</span>
<span class="kn">from</span> <span class="nn">pykrylov.tfqmr</span> <span class="kn">import</span> <span class="n">TFQMR</span>
<span class="kn">from</span> <span class="nn">pykrylov.bicgstab</span> <span class="kn">import</span> <span class="n">BiCGSTAB</span>
<span class="kn">from</span> <span class="nn">pysparse</span> <span class="kn">import</span> <span class="n">spmatrix</span>
<span class="kn">from</span> <span class="nn">pysparse.pysparseMatrix</span> <span class="kn">import</span> <span class="n">PysparseMatrix</span> <span class="k">as</span> <span class="n">sp</span>

<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>

<span class="n">hdr</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%10s</span><span class="s">  </span><span class="si">%6s</span><span class="s">  </span><span class="si">%8s</span><span class="s">  </span><span class="si">%8s</span><span class="s">  </span><span class="si">%8s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="s">&#39;Matvec&#39;</span><span class="p">,</span> <span class="s">&#39;Resid0&#39;</span><span class="p">,</span> <span class="s">&#39;Resid&#39;</span><span class="p">,</span> <span class="s">&#39;Error&#39;</span><span class="p">)</span>
<span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%10s</span><span class="s">  </span><span class="si">%6d</span><span class="s">  </span><span class="si">%8.2e</span><span class="s">  </span><span class="si">%8.2e</span><span class="s">  </span><span class="si">%8.2e</span><span class="s">&#39;</span>
<span class="k">print</span> <span class="n">hdr</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">sp</span><span class="p">(</span><span class="n">matrix</span><span class="o">=</span><span class="n">spmatrix</span><span class="o">.</span><span class="n">ll_mat_from_mtx</span><span class="p">(</span><span class="s">&#39;jpwh_991.mtx&#39;</span><span class="p">))</span>

<span class="n">n</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">rhs</span> <span class="o">=</span> <span class="n">A</span><span class="o">*</span><span class="n">e</span>

<span class="c"># Loop through solvers using tighter stopping tolerance</span>
<span class="k">for</span> <span class="n">KSolver</span> <span class="ow">in</span> <span class="p">[</span><span class="n">CGS</span><span class="p">,</span> <span class="n">TFQMR</span><span class="p">,</span> <span class="n">BiCGSTAB</span><span class="p">]:</span>
    <span class="n">ks</span> <span class="o">=</span> <span class="n">KSolver</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">A</span><span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">reltol</span><span class="o">=</span><span class="mf">1.0e-8</span><span class="p">)</span>
    <span class="n">ks</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">guess</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span> <span class="n">matvec_max</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>

    <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ks</span><span class="o">.</span><span class="n">bestSolution</span><span class="o">-</span><span class="n">e</span><span class="p">)</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">fmt</span> <span class="o">%</span> <span class="p">(</span><span class="n">ks</span><span class="o">.</span><span class="n">acronym</span><span class="p">,</span> <span class="n">ks</span><span class="o">.</span><span class="n">nMatvec</span><span class="p">,</span> <span class="n">ks</span><span class="o">.</span><span class="n">residNorm0</span><span class="p">,</span> <span class="n">ks</span><span class="o">.</span><span class="n">residNorm</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</pre></div>
</div>
<p>Executing the script above produces the formatted output:</p>
<div class="highlight-python"><div class="highlight"><pre>     Name  Matvec    Resid0     Resid     Error
      CGS      82  8.64e+03  3.25e-05  2.35e-06
    TFQMR      84  8.64e+03  8.97e-06  1.22e-06
Bi-CGSTAB      84  8.64e+03  5.57e-05  4.04e-06
</pre></div>
</div>
<div class="section" id="example-with-preconditioning">
<h2>9.1. Example with Preconditioning<a class="headerlink" href="#example-with-preconditioning" title="Permalink to this headline">¶</a></h2>
<p>A preconditioner can be supplied to any Krylov solver via the <cite>precon</cite> keyword
argument upon instantiation.</p>
<p>For example, we could supply a simple (and naive) diagonal preconditioner by
modifying the benchmarking script as:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pykrylov.cgs</span> <span class="kn">import</span> <span class="n">CGS</span>
<span class="kn">from</span> <span class="nn">pykrylov.tfqmr</span> <span class="kn">import</span> <span class="n">TFQMR</span>
<span class="kn">from</span> <span class="nn">pykrylov.bicgstab</span> <span class="kn">import</span> <span class="n">BiCGSTAB</span>
<span class="kn">from</span> <span class="nn">pysparse</span> <span class="kn">import</span> <span class="n">spmatrix</span>
<span class="kn">from</span> <span class="nn">pysparse.pysparseMatrix</span> <span class="kn">import</span> <span class="n">PysparseMatrix</span> <span class="k">as</span> <span class="n">sp</span>

<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>

<span class="n">hdr</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%10s</span><span class="s">  </span><span class="si">%6s</span><span class="s">  </span><span class="si">%8s</span><span class="s">  </span><span class="si">%8s</span><span class="s">  </span><span class="si">%8s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;Name&#39;</span><span class="p">,</span> <span class="s">&#39;Matvec&#39;</span><span class="p">,</span> <span class="s">&#39;Resid0&#39;</span><span class="p">,</span> <span class="s">&#39;Resid&#39;</span><span class="p">,</span> <span class="s">&#39;Error&#39;</span><span class="p">)</span>
<span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%10s</span><span class="s">  </span><span class="si">%6d</span><span class="s">  </span><span class="si">%8.2e</span><span class="s">  </span><span class="si">%8.2e</span><span class="s">  </span><span class="si">%8.2e</span><span class="s">&#39;</span>
<span class="k">print</span> <span class="n">hdr</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">sp</span><span class="p">(</span><span class="n">matrix</span><span class="o">=</span><span class="n">spmatrix</span><span class="o">.</span><span class="n">ll_mat_from_mtx</span><span class="p">(</span><span class="s">&#39;jpwh_991.mtx&#39;</span><span class="p">))</span>

<span class="c"># Extract diagonal of A and make it sufficiently positive</span>
<span class="n">diagA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">takeDiagonal</span><span class="p">()),</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="n">n</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">rhs</span> <span class="o">=</span> <span class="n">A</span><span class="o">*</span><span class="n">e</span>

<span class="c"># Loop through solvers using default stopping tolerance</span>
<span class="k">for</span> <span class="n">KSolver</span> <span class="ow">in</span> <span class="p">[</span><span class="n">CGS</span><span class="p">,</span> <span class="n">TFQMR</span><span class="p">,</span> <span class="n">BiCGSTAB</span><span class="p">]:</span>
    <span class="n">ks</span> <span class="o">=</span> <span class="n">KSolver</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">A</span><span class="o">*</span><span class="n">v</span><span class="p">,</span>
                 <span class="n">precon</span><span class="o">=</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">u</span><span class="o">/</span><span class="n">diagA</span><span class="p">,</span>
                 <span class="n">reltol</span><span class="o">=</span><span class="mf">1.0e-8</span><span class="p">)</span>
    <span class="n">ks</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">guess</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">),</span> <span class="n">matvec_max</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>

    <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ks</span><span class="o">.</span><span class="n">bestSolution</span><span class="o">-</span><span class="n">e</span><span class="p">)</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">fmt</span> <span class="o">%</span> <span class="p">(</span><span class="n">ks</span><span class="o">.</span><span class="n">acronym</span><span class="p">,</span> <span class="n">ks</span><span class="o">.</span><span class="n">nMatvec</span><span class="p">,</span> <span class="n">ks</span><span class="o">.</span><span class="n">residNorm</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</pre></div>
</div>
<p>This time, the output is a bit better than before:</p>
<div class="highlight-python"><div class="highlight"><pre>     Name  Matvec    Resid0     Resid     Error
      CGS      70  8.64e+03  7.84e-06  2.33e-07
    TFQMR      70  8.64e+03  7.61e-06  2.47e-07
Bi-CGSTAB      64  8.64e+03  8.54e-05  4.93e-06
</pre></div>
</div>
<p>Much in the same way, a modification of the script above could be used to loop
through preconditioners with a given solver.</p>
<p>Note that preconditioners need not be functions but can be more general
objects. The only requirement is that they should be callable. For example, the
same effect as above can be achieved by instead defining the preconditioner as:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">DiagonalPrec</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;Diag&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">takeDiagonal</span><span class="p">()),</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="s">&quot;Return the result of applying preconditioner to y&quot;</span>
        <span class="k">return</span> <span class="n">y</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">diag</span>
</pre></div>
</div>
<p>If <cite>dp</cite> is an instance of the <cite>DiagonalPrec</cite> class and <cite>y</cite> is a Numpy array of
appropriate size, one solves preconditioning systems by simply calling
<cite>x=dp(y)</cite>. A call to a Krylov solver might thus look like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Create diagonal preconditioner</span>
<span class="n">dp</span> <span class="o">=</span> <span class="n">DiagonalPrec</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>

<span class="n">ks</span> <span class="o">=</span> <span class="n">KSolver</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">A</span><span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">precon</span><span class="o">=</span><span class="n">dp</span><span class="p">,</span> <span class="n">reltol</span><span class="o">=</span><span class="mf">1.0e-8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
<div id="sourcelink">
  <a href="_sources/bmark.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2014, D. Orban.<br/>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>